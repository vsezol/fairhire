import { app, BrowserWindow, ipcMain, shell, session } from 'electron';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import {
  VideoCallStrategy,
  VideoCallStrategyFactory,
} from './strategies/index.js';
import {
  UnifiedActivityTracker,
  createSmartAutoAdapter,
} from './features/activity-tracking/index.js';
import { screenshotProtectionService } from './features/screenshot-protection/index.js';
import { KeyDownEvent } from './preload.js';
import { APP_VERSION } from './version.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

let mainWindow: BrowserWindow;
let browserWindow: BrowserWindow | null = null;
let activityTracker: UnifiedActivityTracker;

process.on('unhandledRejection', (reason, promise) => {
  console.log('Unhandled Rejection at:', promise, 'reason:', reason);
});

function createMainWindow(): void {
  mainWindow = new BrowserWindow({
    width: 450,
    height: 300,
    autoHideMenuBar: true,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      sandbox: false, // –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è ES modules –≤ preload
      preload: join(__dirname, 'preload.js'),
      devTools: false,
    },
    resizable: false,
    maximizable: false,
    title: titleWithVersion('FairHire'),
  });

  mainWindow.setMenu(null);

  screenshotProtectionService.protectWindow(mainWindow);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ HTML —Ñ–∞–π–ª—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ (dev/prod)
  const appPath = join(__dirname, '../../tracker-app/dist/index.html');

  console.log('Loading app from:', appPath);
  mainWindow.loadFile(appPath);

  mainWindow.webContents.on('page-title-updated', (event, title) => {
    mainWindow.setTitle(titleWithVersion(title));
  });

  mainWindow.on('closed', () => {
    if (browserWindow) {
      browserWindow.close();
    }
    app.quit();
  });

  // Handle page load errors
  mainWindow.webContents.on(
    'did-fail-load',
    (event, errorCode, errorDescription, validatedURL) => {
      console.log(
        'Main window failed to load:',
        errorCode,
        errorDescription,
        validatedURL
      );
    }
  );
}

async function createBrowserWindow(url: string): Promise<void> {
  if (browserWindow) {
    try {
      browserWindow.close();
    } catch (error) {
      console.log('Error closing previous browser window:', error);
    }
  }

  const strategy = VideoCallStrategyFactory.getStrategy(url);
  await strategy.warmupSession();

  const maxRetries = 3;
  let lastError: Error | null = null;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(
        `Creating browser window (attempt ${attempt}/${maxRetries})...`
      );
      await createWindow(strategy, url);
      console.log('Browser window created successfully');
      break;
    } catch (error) {
      lastError = error as Error;
      console.log(`Attempt ${attempt} failed:`, error);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ retryable
      const isRetryableError = lastError.message.includes('Retryable error:');

      if (attempt < maxRetries && isRetryableError) {
        console.log(
          `Retrying in 5 seconds... (attempt ${attempt + 1}/${maxRetries})`
        );

        await new Promise((resolve) => setTimeout(resolve, 1000));
      } else if (attempt === maxRetries) {
        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
        console.error(
          'Failed to create browser window after all retries:',
          lastError
        );
        throw lastError;
      } else {
        // –ù–µ retryable –æ—à–∏–±–∫–∞, –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–æ–≤–∞
        console.error('Non-retryable error, stopping attempts:', lastError);
        throw lastError;
      }
    }
  }

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  if (browserWindow) {
    browserWindow.webContents.on('page-title-updated', (event, title) => {
      browserWindow?.setTitle(titleWithVersion(title));
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ renderer –ø—Ä–æ—Ü–µ—Å—Å–µ
    browserWindow.webContents.on('render-process-gone', (event, details) => {
      console.log('Renderer process gone:', details);
    });
  }
}

async function createWindow(
  strategy: VideoCallStrategy,
  url: string
): Promise<BrowserWindow> {
  if (browserWindow) {
    try {
      browserWindow.close();
    } catch (error) {
      console.log('Error closing browser window:', error);
    }
  }

  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  const config = strategy.getWindowConfig();

  browserWindow = new BrowserWindow({
    ...config.windowConfig,
    autoHideMenuBar: true,
    webPreferences: {
      ...config.windowConfig.webPreferences,
      partition: config.sessionPartition,
      sandbox: false,
      preload: join(__dirname, 'preload.js'),
      devTools: false,
    },
  });

  browserWindow.setMenu(null);

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º User Agent
  browserWindow.webContents.setUserAgent(config.userAgent);

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
  strategy.setupHeaders(browserWindow);

  // –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞
  browserWindow.webContents.on('dom-ready', () => {
    const maskingScript = strategy.getMaskingScript();

    browserWindow?.webContents
      .executeJavaScript(maskingScript)
      .catch((error) => {
        console.log('Error executing JavaScript:', error);
      });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    const delays = strategy.getDelays();
    setTimeout(() => {
      browserWindow?.show();
    }, delays.showDelay + Math.random() * 500);
  });

  // Set permissions for media access
  session.defaultSession.setPermissionRequestHandler(
    (webContents, permission, callback) => {
      const allowedPermissions = [
        'camera',
        'microphone',
        'notifications',
        'display-capture',
        'media',
        'mediaKeySystem',
        'geolocation',
        'fullscreen',
        'pointerLock',
      ];
      if (allowedPermissions.includes(permission)) {
        callback(true);
      } else {
        callback(false);
      }
    }
  );

  // Handle external links
  browserWindow.webContents.setWindowOpenHandler(({ url }) => {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º zoomus:// —Å—Å—ã–ª–∫–∏
    if (url.startsWith('zoomus://')) {
      console.log('Blocked external zoomus:// link:', url);
      return { action: 'deny' };
    }
    shell.openExternal(url);
    return { action: 'deny' };
  });

  // –ó–∞—â–∏—â–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
  if (browserWindow) {
    screenshotProtectionService.protectWindow(browserWindow);
    console.log('üõ°Ô∏è Browser window protected from screenshots');
  }

  // –ü—Ä–æ–º–∏—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  return new Promise((resolve, reject) => {
    let isResolved = false;
    let retryCount = 0;

    const resolveOnce = (result: BrowserWindow) => {
      if (!isResolved) {
        isResolved = true;
        resolve(result);
      }
    };

    const rejectOnce = (error: any) => {
      if (!isResolved) {
        isResolved = true;
        reject(error);
      }
    };

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º URL —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
    const preparedUrls = strategy.prepareUrls(url);
    const alternativeUrls = preparedUrls.alternativeUrls;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º URL
    const tryLoadAlternative = () => {
      if (retryCount < alternativeUrls.length) {
        const alternativeUrl = alternativeUrls[retryCount];
        console.log(
          `Trying alternative URL (${retryCount + 1}/${
            alternativeUrls.length
          }):`,
          alternativeUrl
        );
        retryCount++;

        setTimeout(() => {
          if (browserWindow && !browserWindow.isDestroyed()) {
            browserWindow.loadURL(alternativeUrl).catch((error) => {
              console.log('Error loading alternative URL:', error);
              if (retryCount < alternativeUrls.length) {
                tryLoadAlternative();
              } else {
                rejectOnce(new Error('All alternative URLs failed'));
              }
            });
          }
        }, 1000);
      } else {
        rejectOnce(new Error('No more alternative URLs to try'));
      }
    };

    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤—Å–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    const timeout = setTimeout(() => {
      rejectOnce(new Error('Load timeout'));
    }, 30000);

    if (browserWindow) {
      browserWindow.webContents.on('did-finish-load', () => {
        console.log('Page loaded successfully');

        console.log('üñ±Ô∏è Setting up mouse click tracking after page load...');
        activityTracker.setupMouseClickTracking(browserWindow!);

        clearTimeout(timeout);
        resolveOnce(browserWindow!);
      });

      browserWindow.webContents.on(
        'did-fail-load',
        (event, errorCode, errorDescription, validatedURL) => {
          console.log(
            'Page failed to load:',
            errorCode,
            errorDescription,
            validatedURL
          );

          // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CSP –æ—à–∏–±–æ–∫
          if (errorCode === -30 && validatedURL.includes('metrika')) {
            console.log('Ignoring CSP error from analytics/tracking service');
            return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º CSP –æ—à–∏–±–∫–∏ –æ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
          if (strategy.shouldRetryOnError(errorCode, validatedURL)) {
            console.log('Strategy suggests retry, trying alternative URL...');
            tryLoadAlternative();
            return;
          }

          clearTimeout(timeout);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã retry
          const isRetryableError =
            errorCode === -101 ||
            errorCode === -105 ||
            errorCode === -106 ||
            errorCode === -2 ||
            errorCode === -30; // CSP errors are often non-critical (ads, analytics)

          if (isRetryableError) {
            rejectOnce(
              new Error(`Retryable error: ${errorDescription} (${errorCode})`)
            );
          } else {
            rejectOnce(
              new Error(`Load failed: ${errorDescription} (${errorCode})`)
            );
          }
        }
      );

      browserWindow.on('closed', async () => {
        await activityTracker.stopTracking().catch(console.error);
        console.log('Activity tracking stopped due to window close');

        browserWindow = null;
        clearTimeout(timeout);
        rejectOnce(new Error('Window closed'));
      });
    } else {
      rejectOnce(new Error('Browser window not created'));
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ URL —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    const delays = strategy.getDelays();
    const loadDelay = delays.loadDelay || 100;

    setTimeout(() => {
      if (browserWindow && !browserWindow.isDestroyed()) {
        console.log(`Loading ${strategy.name} strategy for URL...`);
        browserWindow.loadURL(preparedUrls.primaryUrl).catch((error) => {
          console.log('Error loading URL:', error);
          if (strategy.shouldUseAlternativeOnLoadError()) {
            tryLoadAlternative();
          }
        });
      }
    }, loadDelay);
  });
}

// IPC handlers
ipcMain.handle('open-url', async (event, url: string) => {
  try {
    // Validate URL
    new URL(url);
    await createBrowserWindow(url);

    if (activityTracker) {
      await activityTracker.startTracking(url, browserWindow!);
      console.log('Activity tracking started for call:', url);
    }

    return { success: true };
  } catch (error) {
    console.error('Error in open-url handler:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Invalid URL',
    };
  }
});

ipcMain.handle(
  'activity-tracker:mouse-click',
  (_, x: number, y: number, button?: string) => {
    if (!activityTracker) {
      return { success: false, error: 'Activity tracker not initialized' };
    }
    activityTracker.addMouseClickEvent(x, y, button);
    return { success: true };
  }
);
ipcMain.handle('activity-tracker:key-down', (_, event: KeyDownEvent) => {
  if (!activityTracker) {
    return { success: false, error: 'Activity tracker not initialized' };
  }
  activityTracker.addKeyDownEvent(event);
  return { success: true };
});

// Add Chrome command line switches for better video call compatibility
app.commandLine.appendSwitch('--enable-media-stream');
app.commandLine.appendSwitch('--enable-usermedia-screen-capturing');
app.commandLine.appendSwitch('--allow-http-screen-capture');
app.commandLine.appendSwitch('--auto-select-desktop-capture-source', 'Screen');
app.commandLine.appendSwitch('--enable-experimental-web-platform-features');

// –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞
app.commandLine.appendSwitch('--disable-blink-features=AutomationControlled');
app.commandLine.appendSwitch('--no-first-run');
app.commandLine.appendSwitch('--no-default-browser-check');
app.commandLine.appendSwitch('--disable-background-timer-throttling');
app.commandLine.appendSwitch('--disable-renderer-backgrounding');
app.commandLine.appendSwitch('--disable-backgrounding-occluded-windows');

// –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
app.commandLine.appendSwitch(
  '--enable-features=VaapiVideoDecoder,WebRTCPipeWireCapturer'
);
app.commandLine.appendSwitch('--disable-features=TranslateUI');
app.commandLine.appendSwitch('--enable-gpu-rasterization');
app.commandLine.appendSwitch('--enable-zero-copy');

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ SSL
app.commandLine.appendSwitch('--enable-tls13-early-data');
app.commandLine.appendSwitch('--disable-dev-shm-usage');

// –ù–û–í–´–ï –§–õ–ê–ì–ò –î–õ–Ø –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ –° ZOOM –ò QUIC –ü–†–û–¢–û–ö–û–õ–û–ú
app.commandLine.appendSwitch('--disable-quic');
app.commandLine.appendSwitch('--disable-http2');
app.commandLine.appendSwitch('--disable-features=VizDisplayCompositor');
app.commandLine.appendSwitch('--ignore-certificate-errors');
app.commandLine.appendSwitch('--ignore-ssl-errors');
app.commandLine.appendSwitch('--ignore-certificate-errors-spki-list');
app.commandLine.appendSwitch('--disable-web-security');
app.commandLine.appendSwitch('--allow-running-insecure-content');
app.commandLine.appendSwitch('--disable-site-isolation-trials');

app.whenReady().then(async () => {
  const adapter = await createSmartAutoAdapter({
    jsonOutputPath: join(process.cwd(), 'activity-session.json'),
    preferSupabase: true, // –ü–æ–ø—Ä–æ–±—É–µ—Ç Supabase, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ JSON
  });

  activityTracker = new UnifiedActivityTracker(adapter);
  await activityTracker.initialize(); // –ü—Ä–æ–≤–µ—Ä–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–µ—Ä–∞

  createMainWindow();

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createMainWindow();
    }
  });
});

app.on('window-all-closed', async () => {
  // Stop tracking when app closes
  if (activityTracker) {
    await activityTracker.destroy().catch(console.error);
  }

  screenshotProtectionService.cleanup();

  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('before-quit', () => {
  screenshotProtectionService.cleanup();
});

// Security: Prevent new window creation except through our handler
app.on('web-contents-created', (event, contents) => {
  contents.setWindowOpenHandler(({ url }) => {
    shell.openExternal(url);
    return { action: 'deny' };
  });
});

function titleWithVersion(title: string): string {
  return `${title} ${APP_VERSION}`;
}
